<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RSA BigInt Demo</title>
</head>
<body>

<h2>RSA Demo (BigInt)</h2>

p: <input type="number" id="p" value="17"><br><br>
q: <input type="number" id="q" value="11"><br><br>
e: <input type="number" id="e" value="27"><br><br>

<button onclick="createKey()">Tạo khóa</button>

<p id="keyInfo"></p>

<hr>

Text: <input type="text" id="plain" value="Hello">
<button onclick="encrypt()">Mã hóa</button>
<p id="cipher"></p>

<hr>

Cipher: <input type="text" id="cipherInput">
<button onclick="decrypt()">Giải mã</button>
<p id="result"></p>

<script>

let n, phi, e, d;

// =================
// MOD POW BigInt
// =================
function modPow(base, exp, mod) {
    base = BigInt(base);
    exp = BigInt(exp);
    mod = BigInt(mod);

    let result = 1n;
    base = base % mod;

    while (exp > 0n) {
        if (exp % 2n === 1n)
            result = (result * base) % mod;

        exp = exp / 2n;
        base = (base * base) % mod;
    }
    return result;
}

// =================
// GCD
// =================
function gcd(a, b) {
    while (b !== 0n) {
        let temp = b;
        b = a % b;
        a = temp;
    }
    return a;
}

// =================
// FIND D
// =================
function findD(e, phi) {
    for (let i = 1n; i < phi; i++) {
        if ((i * e) % phi === 1n)
            return i;
    }
    return null;
}

// =================
// CREATE KEY
// =================
function createKey() {
    let p = BigInt(document.getElementById("p").value);
    let q = BigInt(document.getElementById("q").value);
    e = BigInt(document.getElementById("e").value);

    n = p * q;
    phi = (p - 1n) * (q - 1n);

    if (gcd(e, phi) !== 1n) {
        alert("e không nguyên tố cùng nhau với phi");
        return;
    }

    d = findD(e, phi);

    document.getElementById("keyInfo").innerHTML =
        "n = " + n +
        "<br>phi = " + phi +
        "<br>d = " + d;
}

// =================
// ENCRYPT
// =================
function encrypt() {
    let text = document.getElementById("plain").value;
    let result = [];

    for (let i = 0; i < text.length; i++) {
        let m = BigInt(text.charCodeAt(i));
        let c = modPow(m, e, n);
        result.push(c.toString());
    }

    let cipher = result.join(" ");
    document.getElementById("cipher").innerHTML = "Cipher: " + cipher;
    document.getElementById("cipherInput").value = cipher;
}

// =================
// DECRYPT
// =================
function decrypt() {
    let cipher = document.getElementById("cipherInput").value;
    let parts = cipher.split(" ");
    let result = "";

    for (let part of parts) {
        let c = BigInt(part);
        let m = modPow(c, d, n);
        result += String.fromCharCode(Number(m));
    }

    document.getElementById("result").innerHTML =
        "Giải mã: " + result;
}

</script>

</body>
</html>
